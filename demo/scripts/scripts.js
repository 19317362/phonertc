"use strict";angular.module("config",[]).constant("ENV",{name:"production",apiEndpoint:"http://api.yoursite.com/"}),angular.module("phonertcdemo",["ionic","ui.router","config","btford.socket-io"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("app",{url:"/app","abstract":!0,templateUrl:"templates/app.html"}).state("app.login",{url:"/login",controller:"LoginCtrl",templateUrl:"templates/login.html"}).state("app.contacts",{url:"/contacts",controller:"ContactsCtrl",templateUrl:"templates/contacts.html"}).state("app.call",{url:"/call/:contactName?isCalling",controller:"CallCtrl",templateUrl:"templates/call.html"}),b.otherwise("/app/login")}]).run(["$ionicPlatform",function(a){a.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault()})}]).run(["$state","signaling",function(a,b){b.on("messageReceived",function(b,c){switch(c.type){case"call":a.go("app.call",{isCalling:!1,contactName:b})}})}]),angular.module("phonertcdemo").factory("signaling",["socketFactory",function(a){var b=io.connect("http://212.179.18.70:3000/"),a=a({ioSocket:b});return a}]),angular.module("phonertcdemo").factory("ContactsService",["signaling",function(a){var b=[];return a.on("online",function(a){-1===b.indexOf(a)&&b.push(a)}),a.on("offline",function(a){var c=b.indexOf(a);-1!==c&&b.splice(c,1)}),{onlineUsers:b,setOnlineUsers:function(a,c){b.length=0,a.forEach(function(a){a!==c&&b.push(a)})}}}]),angular.module("phonertcdemo").controller("LoginCtrl",["$scope","$state","$ionicPopup","signaling","ContactsService",function(a,b,c,d,e){a.data={},a.loading=!1,a.login=function(){a.loading=!0,d.emit("login",a.data.name)},d.on("login_error",function(b){a.loading=!1;c.alert({title:"Error",template:b})}),d.on("login_successful",function(c){e.setOnlineUsers(c,a.data.name),b.go("app.contacts")})}]),angular.module("phonertcdemo").controller("ContactsCtrl",["$scope","ContactsService",function(a,b){a.contacts=b.onlineUsers}]),angular.module("phonertcdemo").controller("CallCtrl",["$scope","$state","$rootScope","$stateParams","signaling",function(a,b,c,d,e){function f(c){var d={isInitiator:c,turn:{host:"turn:ec2-54-68-238-149.us-west-2.compute.amazonaws.com:3478",username:"test",password:"test"},streams:{audio:!0,video:!0}};j=new cordova.plugins.phonertc.Session(d),j.on("sendMessage",function(b){i=!0,e.emit("sendMessage",a.contactName,{type:"phonertc_handshake",data:JSON.stringify(b)})}),j.on("answer",function(){alert("Answered!"),i=!0}),j.on("disconnect",function(){e.emit("sendMessage",a.contactName,{type:"ignore"}),b.go("app.contacts")}),j.call()}function g(c,d){if(console.log("messageReceived",c,a.contactName,d),c===a.contactName)switch(d.type){case"answer":a.$apply(function(){a.callInProgress=!0}),f(!0);break;case"ignore":i?j.disconnect():b.go("app.contacts");break;case"phonertc_handshake":-1===h.indexOf(d.data)?(j.receiveMessage(JSON.parse(d.data)),h.push(d.data)):console.log("-----> prevented duplicate message")}}var h=[],i=!1;a.callInProgress=!1,a.isCalling="true"===d.isCalling,a.contactName=d.contactName;var j;a.isCalling&&e.emit("sendMessage",a.contactName,{type:"call"}),a.ignore=function(){i?j.disconnect():(e.emit("sendMessage",a.contactName,{type:"ignore"}),b.go("app.contacts"))},a.answer=function(){a.callInProgress||(a.callInProgress=!0,f(!1),setTimeout(function(){console.log("sending answer"),e.emit("sendMessage",a.contactName,{type:"answer"})},3500))},a.updateVideoPosition=function(){"android"!==cordova.platformId&&c.$broadcast("videoView.updatePosition")},e.on("messageReceived",g),a.$on("$destroy",function(){console.log("remove listener"),e.removeListener("messageReceived",g)})}]),angular.module("phonertcdemo").directive("videoView",["$rootScope","$timeout",function(a,b){return{restrict:"E",template:'<div class="video-container"></div>',replace:!0,link:function(c,d){function e(){cordova.plugins.phonertc.setVideoView({container:d[0],local:{position:[0,0],size:[100,100]}})}b(e,500),a.$on("videoView.updatePosition",e)}}}]);